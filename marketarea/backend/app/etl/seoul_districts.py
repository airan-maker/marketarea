"""서울 25개 구 코드, 이름, 중심 좌표 매핑 + 행정동 중심 좌표."""
from sqlalchemy import text
from sqlalchemy.orm import Session
from app.etl.logger import get_etl_logger

logger = get_etl_logger("seoul_districts")

# 서울 25개 구: 법정동코드 앞 5자리 → 이름, 중심 좌표
SEOUL_GU = {
    "11110": {"name": "종로구",   "lat": 37.5735, "lng": 126.9790},
    "11140": {"name": "중구",     "lat": 37.5641, "lng": 126.9979},
    "11170": {"name": "용산구",   "lat": 37.5326, "lng": 126.9900},
    "11200": {"name": "성동구",   "lat": 37.5633, "lng": 127.0371},
    "11215": {"name": "광진구",   "lat": 37.5385, "lng": 127.0823},
    "11230": {"name": "동대문구", "lat": 37.5744, "lng": 127.0396},
    "11260": {"name": "중랑구",   "lat": 37.6063, "lng": 127.0928},
    "11290": {"name": "성북구",   "lat": 37.5894, "lng": 127.0167},
    "11305": {"name": "강북구",   "lat": 37.6396, "lng": 127.0255},
    "11320": {"name": "도봉구",   "lat": 37.6688, "lng": 127.0471},
    "11350": {"name": "노원구",   "lat": 37.6542, "lng": 127.0568},
    "11380": {"name": "은평구",   "lat": 37.6027, "lng": 126.9291},
    "11410": {"name": "서대문구", "lat": 37.5791, "lng": 126.9368},
    "11440": {"name": "마포구",   "lat": 37.5664, "lng": 126.9018},
    "11470": {"name": "양천구",   "lat": 37.5170, "lng": 126.8664},
    "11500": {"name": "강서구",   "lat": 37.5509, "lng": 126.8495},
    "11530": {"name": "구로구",   "lat": 37.4954, "lng": 126.8874},
    "11545": {"name": "금천구",   "lat": 37.4519, "lng": 126.8955},
    "11560": {"name": "영등포구", "lat": 37.5264, "lng": 126.8963},
    "11590": {"name": "동작구",   "lat": 37.5124, "lng": 126.9393},
    "11620": {"name": "관악구",   "lat": 37.4784, "lng": 126.9516},
    "11650": {"name": "서초구",   "lat": 37.4837, "lng": 127.0324},
    "11680": {"name": "강남구",   "lat": 37.5172, "lng": 127.0473},
    "11710": {"name": "송파구",   "lat": 37.5145, "lng": 127.1060},
    "11740": {"name": "강동구",   "lat": 37.5301, "lng": 127.1238},
}

# 서울 주요 행정동 중심 좌표 (유동인구/인구 매핑용)
# 행정동코드 → 이름, 중심 좌표
SEOUL_DONG = {
    # 종로구
    "11110515": {"name": "청운효자동", "lat": 37.5841, "lng": 126.9706},
    "11110530": {"name": "사직동",     "lat": 37.5760, "lng": 126.9685},
    "11110540": {"name": "삼청동",     "lat": 37.5830, "lng": 126.9820},
    "11110550": {"name": "부암동",     "lat": 37.5930, "lng": 126.9650},
    "11110560": {"name": "평창동",     "lat": 37.6100, "lng": 126.9700},
    "11110570": {"name": "무악동",     "lat": 37.5740, "lng": 126.9610},
    "11110580": {"name": "교남동",     "lat": 37.5690, "lng": 126.9680},
    "11110600": {"name": "종로1.2.3.4가동", "lat": 37.5710, "lng": 126.9830},
    "11110620": {"name": "종로5.6가동",     "lat": 37.5710, "lng": 126.9960},
    "11110640": {"name": "이화동",     "lat": 37.5790, "lng": 127.0040},
    "11110660": {"name": "혜화동",     "lat": 37.5870, "lng": 127.0010},
    "11110670": {"name": "창신1동",    "lat": 37.5750, "lng": 127.0090},
    "11110680": {"name": "창신2동",    "lat": 37.5770, "lng": 127.0120},
    "11110690": {"name": "창신3동",    "lat": 37.5730, "lng": 127.0140},
    "11110700": {"name": "숭인1동",    "lat": 37.5760, "lng": 127.0170},
    "11110710": {"name": "숭인2동",    "lat": 37.5780, "lng": 127.0200},
    # 중구
    "11140510": {"name": "소공동",     "lat": 37.5650, "lng": 126.9810},
    "11140520": {"name": "회현동",     "lat": 37.5590, "lng": 126.9830},
    "11140530": {"name": "명동",       "lat": 37.5610, "lng": 126.9860},
    "11140540": {"name": "필동",       "lat": 37.5590, "lng": 126.9950},
    "11140550": {"name": "장충동",     "lat": 37.5610, "lng": 127.0050},
    "11140560": {"name": "광희동",     "lat": 37.5650, "lng": 127.0070},
    "11140570": {"name": "을지로동",   "lat": 37.5660, "lng": 126.9920},
    "11140590": {"name": "신당동",     "lat": 37.5580, "lng": 127.0110},
    "11140600": {"name": "다산동",     "lat": 37.5590, "lng": 127.0080},
    "11140610": {"name": "약수동",     "lat": 37.5540, "lng": 127.0070},
    "11140620": {"name": "청구동",     "lat": 37.5570, "lng": 127.0130},
    "11140640": {"name": "신당5동",    "lat": 37.5620, "lng": 127.0180},
    "11140650": {"name": "동화동",     "lat": 37.5670, "lng": 127.0030},
    "11140660": {"name": "황학동",     "lat": 37.5700, "lng": 127.0180},
    "11140670": {"name": "중림동",     "lat": 37.5560, "lng": 126.9700},
    # 용산구
    "11170510": {"name": "후암동",     "lat": 37.5450, "lng": 126.9810},
    "11170520": {"name": "용산2가동",  "lat": 37.5340, "lng": 126.9770},
    "11170530": {"name": "남영동",     "lat": 37.5420, "lng": 126.9730},
    "11170540": {"name": "청파동",     "lat": 37.5440, "lng": 126.9660},
    "11170560": {"name": "원효로1동",  "lat": 37.5380, "lng": 126.9630},
    "11170570": {"name": "원효로2동",  "lat": 37.5340, "lng": 126.9560},
    "11170580": {"name": "효창동",     "lat": 37.5430, "lng": 126.9590},
    "11170590": {"name": "용문동",     "lat": 37.5340, "lng": 126.9620},
    "11170600": {"name": "한강로동",   "lat": 37.5280, "lng": 126.9690},
    "11170610": {"name": "이촌1동",    "lat": 37.5220, "lng": 126.9720},
    "11170620": {"name": "이촌2동",    "lat": 37.5170, "lng": 126.9750},
    "11170630": {"name": "이태원1동",  "lat": 37.5340, "lng": 126.9930},
    "11170640": {"name": "이태원2동",  "lat": 37.5380, "lng": 126.9980},
    "11170650": {"name": "한남동",     "lat": 37.5340, "lng": 127.0030},
    "11170660": {"name": "서빙고동",   "lat": 37.5160, "lng": 126.9930},
    "11170670": {"name": "보광동",     "lat": 37.5240, "lng": 127.0050},
    # 성동구
    "11200510": {"name": "왕십리2동",  "lat": 37.5630, "lng": 127.0370},
    "11200520": {"name": "왕십리도선동", "lat": 37.5670, "lng": 127.0310},
    "11200530": {"name": "마장동",     "lat": 37.5660, "lng": 127.0460},
    "11200540": {"name": "사근동",     "lat": 37.5600, "lng": 127.0480},
    "11200550": {"name": "행당1동",    "lat": 37.5580, "lng": 127.0350},
    "11200560": {"name": "행당2동",    "lat": 37.5560, "lng": 127.0400},
    "11200570": {"name": "응봉동",     "lat": 37.5510, "lng": 127.0290},
    "11200580": {"name": "금호1가동",  "lat": 37.5530, "lng": 127.0180},
    "11200590": {"name": "금호2.3가동", "lat": 37.5510, "lng": 127.0230},
    "11200600": {"name": "금호4가동",  "lat": 37.5480, "lng": 127.0250},
    "11200610": {"name": "옥수동",     "lat": 37.5440, "lng": 127.0180},
    "11200620": {"name": "성수1가1동", "lat": 37.5440, "lng": 127.0510},
    "11200630": {"name": "성수1가2동", "lat": 37.5450, "lng": 127.0560},
    "11200640": {"name": "성수2가1동", "lat": 37.5410, "lng": 127.0600},
    "11200650": {"name": "성수2가3동", "lat": 37.5380, "lng": 127.0650},
    "11200660": {"name": "송정동",     "lat": 37.5350, "lng": 127.0700},
    "11200670": {"name": "용답동",     "lat": 37.5650, "lng": 127.0560},
    # 강남구 (주요 동만)
    "11680510": {"name": "신사동",     "lat": 37.5240, "lng": 127.0230},
    "11680520": {"name": "논현1동",    "lat": 37.5120, "lng": 127.0280},
    "11680530": {"name": "논현2동",    "lat": 37.5100, "lng": 127.0350},
    "11680540": {"name": "압구정동",   "lat": 37.5300, "lng": 127.0280},
    "11680550": {"name": "청담동",     "lat": 37.5260, "lng": 127.0480},
    "11680560": {"name": "삼성1동",    "lat": 37.5140, "lng": 127.0590},
    "11680570": {"name": "삼성2동",    "lat": 37.5110, "lng": 127.0640},
    "11680580": {"name": "대치1동",    "lat": 37.5020, "lng": 127.0580},
    "11680590": {"name": "대치2동",    "lat": 37.4980, "lng": 127.0640},
    "11680600": {"name": "대치4동",    "lat": 37.4950, "lng": 127.0620},
    "11680610": {"name": "역삼1동",    "lat": 37.5010, "lng": 127.0370},
    "11680620": {"name": "역삼2동",    "lat": 37.4960, "lng": 127.0460},
    "11680630": {"name": "도곡1동",    "lat": 37.4900, "lng": 127.0480},
    "11680640": {"name": "도곡2동",    "lat": 37.4870, "lng": 127.0410},
    "11680650": {"name": "개포1동",    "lat": 37.4810, "lng": 127.0560},
    "11680660": {"name": "개포2동",    "lat": 37.4780, "lng": 127.0500},
    "11680670": {"name": "개포4동",    "lat": 37.4750, "lng": 127.0530},
    "11680680": {"name": "세곡동",     "lat": 37.4640, "lng": 127.0700},
    "11680700": {"name": "일원본동",   "lat": 37.4870, "lng": 127.0830},
    "11680710": {"name": "일원1동",    "lat": 37.4840, "lng": 127.0870},
    "11680720": {"name": "일원2동",    "lat": 37.4800, "lng": 127.0900},
    "11680730": {"name": "수서동",     "lat": 37.4880, "lng": 127.1010},
    # 송파구 (주요 동만)
    "11710510": {"name": "잠실본동",   "lat": 37.5130, "lng": 127.0900},
    "11710520": {"name": "잠실2동",    "lat": 37.5080, "lng": 127.0860},
    "11710530": {"name": "잠실3동",    "lat": 37.5110, "lng": 127.0980},
    "11710540": {"name": "잠실4동",    "lat": 37.5060, "lng": 127.0930},
    "11710550": {"name": "잠실6동",    "lat": 37.5170, "lng": 127.1000},
    "11710560": {"name": "잠실7동",    "lat": 37.5200, "lng": 127.1050},
    "11710570": {"name": "풍납1동",    "lat": 37.5280, "lng": 127.1160},
    "11710580": {"name": "풍납2동",    "lat": 37.5240, "lng": 127.1200},
    "11710590": {"name": "삼전동",     "lat": 37.5050, "lng": 127.0910},
    "11710600": {"name": "석촌동",     "lat": 37.5020, "lng": 127.0990},
    "11710610": {"name": "송파1동",    "lat": 37.4990, "lng": 127.1070},
    "11710620": {"name": "송파2동",    "lat": 37.5010, "lng": 127.1120},
    "11710630": {"name": "가락본동",   "lat": 37.4960, "lng": 127.1130},
    "11710640": {"name": "가락1동",    "lat": 37.4930, "lng": 127.1170},
    "11710650": {"name": "가락2동",    "lat": 37.4900, "lng": 127.1200},
    "11710660": {"name": "문정1동",    "lat": 37.4870, "lng": 127.1240},
    "11710670": {"name": "문정2동",    "lat": 37.4840, "lng": 127.1280},
    "11710680": {"name": "장지동",     "lat": 37.4780, "lng": 127.1300},
    "11710690": {"name": "위례동",     "lat": 37.4720, "lng": 127.1350},
    "11710700": {"name": "거여1동",    "lat": 37.4950, "lng": 127.1380},
    "11710710": {"name": "거여2동",    "lat": 37.4920, "lng": 127.1420},
    "11710720": {"name": "마천1동",    "lat": 37.4960, "lng": 127.1480},
    "11710730": {"name": "마천2동",    "lat": 37.4930, "lng": 127.1520},
    # 서초구 (주요 동만)
    "11650510": {"name": "서초1동",    "lat": 37.4920, "lng": 127.0190},
    "11650520": {"name": "서초2동",    "lat": 37.4880, "lng": 127.0240},
    "11650530": {"name": "서초3동",    "lat": 37.4840, "lng": 127.0180},
    "11650540": {"name": "서초4동",    "lat": 37.4960, "lng": 127.0280},
    "11650550": {"name": "잠원동",     "lat": 37.5110, "lng": 127.0130},
    "11650560": {"name": "반포본동",   "lat": 37.5050, "lng": 127.0100},
    "11650570": {"name": "반포1동",    "lat": 37.5050, "lng": 126.9990},
    "11650580": {"name": "반포2동",    "lat": 37.5010, "lng": 127.0040},
    "11650590": {"name": "반포3동",    "lat": 37.5070, "lng": 127.0150},
    "11650600": {"name": "반포4동",    "lat": 37.5030, "lng": 127.0200},
    "11650610": {"name": "방배본동",   "lat": 37.4820, "lng": 126.9880},
    "11650620": {"name": "방배1동",    "lat": 37.4780, "lng": 126.9830},
    "11650630": {"name": "방배2동",    "lat": 37.4750, "lng": 126.9870},
    "11650640": {"name": "방배3동",    "lat": 37.4770, "lng": 126.9920},
    "11650650": {"name": "방배4동",    "lat": 37.4730, "lng": 126.9960},
    "11650660": {"name": "양재1동",    "lat": 37.4720, "lng": 127.0370},
    "11650670": {"name": "양재2동",    "lat": 37.4680, "lng": 127.0420},
    "11650680": {"name": "내곡동",     "lat": 37.4580, "lng": 127.0680},
    # 마포구
    "11440510": {"name": "합정동",     "lat": 37.5490, "lng": 126.9140},
    "11440520": {"name": "망원1동",    "lat": 37.5550, "lng": 126.9080},
    "11440530": {"name": "망원2동",    "lat": 37.5580, "lng": 126.9030},
    "11440540": {"name": "연남동",     "lat": 37.5630, "lng": 126.9220},
    "11440550": {"name": "성산1동",    "lat": 37.5660, "lng": 126.9100},
    "11440560": {"name": "성산2동",    "lat": 37.5700, "lng": 126.9060},
    "11440570": {"name": "상암동",     "lat": 37.5770, "lng": 126.8900},
    "11440580": {"name": "서교동",     "lat": 37.5520, "lng": 126.9220},
    "11440590": {"name": "동교동",     "lat": 37.5570, "lng": 126.9260},
    "11440600": {"name": "마포동",     "lat": 37.5470, "lng": 126.9340},
    "11440610": {"name": "공덕동",     "lat": 37.5440, "lng": 126.9510},
    "11440620": {"name": "아현동",     "lat": 37.5510, "lng": 126.9560},
    "11440630": {"name": "도화동",     "lat": 37.5370, "lng": 126.9480},
    "11440640": {"name": "용강동",     "lat": 37.5370, "lng": 126.9410},
    "11440650": {"name": "대흥동",     "lat": 37.5480, "lng": 126.9420},
    "11440660": {"name": "신수동",     "lat": 37.5440, "lng": 126.9390},
    "11440670": {"name": "신정동",     "lat": 37.5420, "lng": 126.9310},
    # 영등포구
    "11560510": {"name": "영등포본동", "lat": 37.5230, "lng": 126.8990},
    "11560530": {"name": "영등포동",   "lat": 37.5190, "lng": 126.9030},
    "11560540": {"name": "여의동",     "lat": 37.5250, "lng": 126.9240},
    "11560545": {"name": "당산1동",    "lat": 37.5330, "lng": 126.9020},
    "11560550": {"name": "당산2동",    "lat": 37.5370, "lng": 126.9070},
    "11560560": {"name": "도림동",     "lat": 37.5090, "lng": 126.8980},
    "11560570": {"name": "문래동",     "lat": 37.5170, "lng": 126.8960},
    "11560580": {"name": "양평1동",    "lat": 37.5320, "lng": 126.8880},
    "11560590": {"name": "양평2동",    "lat": 37.5350, "lng": 126.8850},
    "11560600": {"name": "신길1동",    "lat": 37.5120, "lng": 126.9160},
    "11560610": {"name": "신길3동",    "lat": 37.5080, "lng": 126.9180},
    "11560620": {"name": "신길4동",    "lat": 37.5050, "lng": 126.9210},
    "11560630": {"name": "신길5동",    "lat": 37.5020, "lng": 126.9190},
    "11560640": {"name": "신길6동",    "lat": 37.5060, "lng": 126.9130},
    "11560650": {"name": "신길7동",    "lat": 37.5090, "lng": 126.9100},
    "11560660": {"name": "대림1동",    "lat": 37.4970, "lng": 126.8970},
    "11560670": {"name": "대림2동",    "lat": 37.4940, "lng": 126.9010},
    "11560680": {"name": "대림3동",    "lat": 37.4920, "lng": 126.9040},
}

# 구 코드 목록 (25개)
GU_CODES = list(SEOUL_GU.keys())


def get_gu_code_from_dong_code(dong_code: str) -> str | None:
    """행정동 코드에서 구 코드(앞 5자리)를 추출."""
    if len(dong_code) >= 5:
        gu = dong_code[:5]
        if gu in SEOUL_GU:
            return gu
    return None


def get_grid_ids_for_gu(session: Session, gu_code: str, radius_m: int = 3000) -> list[int]:
    """구 중심 좌표에서 radius_m 반경 내 grid_id 목록을 반환."""
    gu = SEOUL_GU.get(gu_code)
    if not gu:
        return []
    rows = session.execute(text("""
        SELECT id FROM grid_master
        WHERE ST_DWithin(
            geom::geography,
            ST_SetSRID(ST_MakePoint(:lng, :lat), 4326)::geography,
            :radius
        )
    """), {"lat": gu["lat"], "lng": gu["lng"], "radius": radius_m}).fetchall()
    return [r[0] for r in rows]


def get_grid_ids_for_dong(session: Session, dong_code: str, radius_m: int = 500) -> list[int]:
    """행정동 중심 좌표에서 radius_m 반경 내 grid_id 목록을 반환."""
    dong = SEOUL_DONG.get(dong_code)
    if not dong:
        # 동 코드를 못 찾으면 구 단위로 폴백
        gu_code = get_gu_code_from_dong_code(dong_code)
        if gu_code:
            return get_grid_ids_for_gu(session, gu_code)
        return []
    rows = session.execute(text("""
        SELECT id FROM grid_master
        WHERE ST_DWithin(
            geom::geography,
            ST_SetSRID(ST_MakePoint(:lng, :lat), 4326)::geography,
            :radius
        )
    """), {"lat": dong["lat"], "lng": dong["lng"], "radius": radius_m}).fetchall()
    if not rows:
        # 반경 내 grid가 없으면 구 단위로 폴백
        gu_code = get_gu_code_from_dong_code(dong_code)
        if gu_code:
            return get_grid_ids_for_gu(session, gu_code)
    return [r[0] for r in rows]
